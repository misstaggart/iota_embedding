\message{ !name(paper.tex)}\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{packages}
\usepackage{qtree}

\title{typing}


\begin{document}

\message{ !name(paper.tex) !offset(-3) }


\maketitle
Below, $W_1$ is used for $ \langle w_1, l_1 \rangle$, $W_2$ for $ \langle w_2, l_2 \rangle$, and $U$ for $ \langle u, l \rangle$.\\
Naming conventions are
\begin{itemize}
    \item $W_i$ for starting worlds
    \item $U_i$ for future worlds (usually introduced by a $\forall$)
    \item $V$ for "inner" worlds (usually under a $\rhd$)
\end{itemize}

\section*{preworld}
\subsection{$preworld: K_0$}
Showing $\Gamma \vdash preworld: K_0$ for any $\Gamma$\\
Apply 40 to get
\begin{enumerate}
    \item $\Gamma, w: \underline{K_0} \vdash 
    \N \imp (\rhd w \imp_K \rhd \N \imp U_0) : K
    _0$\\
    Apply 8 to get
    \begin{enumerate}
        \item $\Gamma \dots \vdash \N : U_0$\\
        basic types
        \item $\Gamma, w: \underline{K_0} \vdash (\rhd w \imp_K \rhd \N \imp U_0)$\\
        Apply 13 to get
        \begin{enumerate}
            \item $\Gamma, w: \underline{K_0} \vdash \rhd w :K_0$\\
            32
            \item $\Gamma, w: \underline{K_0} \vdash \rhd \N \imp U_0 : K_0$\\
            Apply 8 
            \begin{enumerate}
                \item $\Gamma, w: \underline{K_0} \vdash \rhd \N : U_0$\\
                32
                \item $\Gamma, w: \underline{K_0} \vdash U_0 : K_0$\\
                97
            \end{enumerate}
        \end{enumerate}
    \end{enumerate}
    \item $0: level$\\
    done
\end{enumerate}
Showing $\Gamma \vdash \rhd preworld : K_0$.\\
32 on above. Need lemma allowing weakening to promote($\Gamma$).

\subsection{$\Gamma \vdash w_1 \: i \: u \: l : U_0$}
Given $\Gamma \vdash W_1 : world$, $\Gamma \vdash i : \N$, $\Gamma \vdash u : \rhd preworld$, $\Gamma \vdash l : \rhd \N$.\\
 Apply 6 to get
   \[\Gamma \vdash w_1 i u: \Pi(y: \rhd \N). U_0 \]
Apply 108, 11 to get
\[\Gamma \vdash w_1 i u:  \rhd \N \imp U_0 \]
Applying 6, 108, (11 and 16 with transitivity) gives
\[\Gamma \vdash w_1 i: \rhd pw \imp_k \rhd \N \imp U_0 \]
Applying 6, 108, 11 again gives 
\[\Gamma \vdash w_1: \N \imp \rhd pw \imp_k \rhd \N \imp U_0 \]
      Applying 108, 43 gives
\begin{itemize}
       \item $\Gamma \vdash w_1: \mu w. \N \imp \rhd w \imp_k \rhd \N \imp U_0 $\\
         Beta reduction on $\pi_1 W_1$, using $\Gamma \vdash \langle w_1, l_1 \rangle : world$.
      \item $\Gamma, w: \underline{type} \vdash \N \imp \rhd w \imp_k \rhd \N \imp U_0 : type $\\
            preworld, 101, 105
                  \end{itemize}
                  
\subsection{$cons_b$}
(cons on the back)\\
$cons_b \; w_1 \: l_1 \; x$ is defined as
\[ \lambda i. ite (i <_b l_1) (w_1 i) (x)\]
Showing that if $\Gamma \vdash w_1 : preworld$ and
and $\Gamma \vdash l_1 : \N$ and
$\Gamma \vdash x: \rhd pw \imp_k \rhd \N \imp U_0$, then \\$\Gamma \vdash cons_b \; w_1 \: l_1 \; x : pw$.

%start here


\section*{subseq}
\subsection*{$\Gamma \vdash W_1 \leq W_2:U_0$}
For $\Gamma$ where $\Gamma \vdash W_i: world$.
Apply 27 to get
\begin{itemize}
    \item $\Gamma \vdash l_1 \leq l_2 : U_0$\\
      Beta reduction on $\pi_1 W_1$, using $\Gamma \vdash \langle w_1, l_1 \rangle : world$.
         Beta reduction on $\pi_2 W_j$, using $\Gamma \vdash \langle w_j, l_j \rangle : world$, gives
    $\Gamma \vdash l_j: nat$ for $j \in \{1, 2\}$. Then use basic types. 
    \item $\Gamma \vdash \forall(u: \rhd pw)\Pi(l: \rhd \N)\Pi(i: \N)\Pi(m : i \leq l_1)(w_1 \: i \: u \: l = w_2 \: i \: u \: l : type): U_0$\\
    Apply 66 to get 
    \[\Gamma, u: \rhd pw \vdash \Pi(l: \rhd \N)\Pi(i: \N)\Pi(m : i \leq l_1)(w_1 \: i \: u \: l = w_2 \: i \: u \: l : type): U_0\]
    Apply 4 to get 
    \[\rhd \N: U_0\] which is easy by 34 and basic types
    as well as
    \[\Gamma, u: \rhd pw , l : \rhd \N \vdash \Pi(i: \N)\Pi(m : i \leq l_1)(w_1 \: i \: u \: l = w_2 \: i \: u \: l : type): U_0\]
Apply 4 again 
    \[\Gamma, u: \rhd pw , l : \rhd \N, i: \N, m: i \leq l_1 \vdash (w_1 \: i \: u \: l = w_2 \: i \: u \: l : type): U_0\]
    (where $\Gamma, u: \rhd pw , l : \rhd \N, i: \N \vdash m: i \leq l_1 : U_0$ follows from basic types and the fact that $\Gamma \vdash l_i: nat$).\\
    Apply 107 
    \[\Gamma, u: \rhd pw , l : \rhd \N, i: \N, m: i \leq l_1 \vdash w_j \: i \: u \: l : U_i\]
    This follows from preworld

\end{itemize}
\subsection{transitivity}
$\Gamma, m_1: W_1 \leq W_2, m_2 : W_2 \leq W_3 \vdash \langle *,
\lambda l. \lambda i. \lambda m. * \rangle
: W_1 \leq W_3$\\
Apply (108 with 28) then 20 to get
\begin{itemize}
    \item \[\Gamma, m_1: W_1 \leq W_2, m_2 : W_2 \leq W_3 \vdash, *: l_1 \leq l_3\]
    Apply 119, taking advantage of rule 28 and the fact that if $\Gamma \vdash A = B$ then $\Gamma \vdash A \leq B$ (basic types)
    \[\Gamma, m_1: \Sigma(l_1 \leq l_2).B, m_2 :\Sigma(l_2 \leq l_3).B \vdash, *: l_1 \leq l_3\]
    From here, I have by 21 that 
    \[\Gamma, m_1: \Sigma(l_1 \leq l_2).B, m_2 :\Sigma(l_2 \leq l_3).B \vdash \vdash \pi_1 m_1 : l_1 \leq l_2\] and  \[\Gamma, m_1: \Sigma(l_1 \leq l_2).B, m_2 :\Sigma(l_2 \leq l_3).B \vdash \vdash \pi_1 m_2 : l_2 \leq l_3\]
    I can then apply transitivity of $\leq$ (basic types) to get that 
     \[\Gamma \dots \vdash, *: l_1 \leq l_3\]
    \item \[\Gamma, m_1: W_1 \leq W_2, m_2 : W_2 \leq W_3 \vdash \lambda l. \lambda i. \lambda m. *: \forall(u: \rhd pw)\Pi(l: \rhd \N).\Pi(i: \N)\Pi(m: i \leq l_1)(w_1 \: i \: u \: l = w_3 \: i \: u \: l : type)\]
    Apply 67
    \[\Gamma, m_1: W_1 \leq W_2, m_2 : W_2 \leq W_3, u: \rhd pw \vdash \lambda l. \lambda i. \lambda m. *: \Pi(l: \rhd \N).\Pi(i: \N)\Pi(m: i \leq l_1)(w_1 \: i \: u \: l = w_3 \: i \: u \: l : type)\]
    Apply 5 multiple times
        \[\Gamma, m_1: W_1 \leq W_2, m_2 : W_2 \leq W_3, u: \rhd pw, l : \rhd \N, i: \N, m: i \leq l_1 \vdash *: (w_1 \: i \: u \: l = w_3 \: i \: u \: l : type)\]
        I denote $\Gamma, m_1: W_1 \leq W_2, m_2 : W_2 \leq W_3, u: \rhd pw, l : \rhd \N, i: \N, m: i \leq l_1$ as $\Gamma'$. 
    It suffices to show there is an $x, y$ where
    \[\Gamma' \vdash x : (w_1 \: i \: u \: l = w_2 \: i \: u \: l : type) \]
    and
    \[\Gamma' \vdash y : (w_2 \: i \: u \: l = w_3 \: i \: u \: l : type) \]
    \begin{itemize}
        \item I assume the existence of such an $x, y$. Then,\\
    Result 5 of basic types gives
     \[\Gamma' \vdash w_1 \: i \: u \: l = w_2 \: i \: u \: l : type \] and
       \[\Gamma' \vdash (w_2 \: i \: u \: l = w_3 \: i \: u \: l : type) \]
       Then 110 gives
        \[\Gamma' \vdash w_1 \: i \: u \: l = w_3 \: i \: u \: l : type \]
       which is equivalent to the desired
         \[\Gamma' \vdash *: (w_1 \: i \: u \: l = w_3 \: i \: u \: l : type) \]
         
\item I show  \[\Gamma' \vdash (\pi_2 \: m_1) l \: i \: m : (w_1 \: i \: u \: l = w_2 \: i \: u \: l : type) \:\: (1)\]
    and
    \[\Gamma' \vdash (\pi_2 \: m_2) l \: i \: ((\pi_1 m_1) \circ m): (w_2 \: i \: u \: l = w_3 \: i \: u \: l : type) \:\: (2)\]
    The proofs go similarly, so I show only 1 for now.
    Apply 119 with 28 and result 4 of basic types.
     \[\Gamma, \dots, m_1: \Sigma(l_1 \leq l_2).B, u: \rhd pw, l : \rhd \N, i: \N, m: i \leq l_1 \vdash (\pi_2 \: m_1) l \: i \: m : (w_1 \: i \: u \: l = w_2 \: i \: u \: l : type) \]
     Applying 6 multiple times gives 
       \[\Gamma, \dots, m_1: \Sigma(l_1 \leq l_2).B, u: \rhd pw, l : \rhd \N, i: \N, m: i \leq l_1 \vdash (\pi_2 \: m_1):\]
       \[\Pi(l: \rhd \N)\Pi(i: \N)\Pi(m: i \leq l_1)(w_1 \: i \: u \: l = w_2 \: i \: u \: l : type) \]
       But this follows from 22.\\
       The proof of 2 requires only the additional explanation that $(\pi_1 m_1) \circ m: i \leq l_2$. But, this comes from transitivity of $\leq$ and the typing of $m_1$ and rule 21.
    \end{itemize}
\end{itemize}

\subsection{reflexivity}
if $\Gamma \vdash W : world$ then $\Gamma \vdash * : W \leq W$.
%start here

\subsection{$cons_b$}
if $\Gamma \vdash W_1 : world$ and $\Gamma \vdash x: \rhd pw \imp_k \imp \rhd \N \imp U_0$, then\\ $\Gamma \vdash \langle *, \lambda l_v. \lambda i. \lambda m_i. * \rangle : W_1 \leq \langle (cons_b \:w_1 \: l_1 \:x), succ(l_1) \rangle$.\\
I abbreviate $cons_b \:w_1 \: l_1 \:x$ as $w_2$.\\
Applying 108 with 28, then 20 yields
     $\Gamma \vdash  *: l_1 \leq succ(l_1)$ (which is done in basic types) as well as 
     \[\Gamma \vdash \lambda l_v. \lambda i. \lambda m_i. * : \]
     \[\forall(v: \rhd pw)\Pi(l_v: \rhd \N )\Pi(i: \N)\Pi(m: i < l_1).(w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v): type
     \]
     Apply 67 
      \[\Gamma, v: \rhd pw \vdash \lambda l_v. \lambda i. \lambda m_i. * : \]
     \[\Pi(l_v: \rhd \N )\Pi(i: \N)\Pi(m: i < l_1).(w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v): type
     \]
     Applying 5 x3 gives 
       \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: i < l_1  \vdash  * :  (w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v): type
     \]
     I apply 119, taking advantage of the reflection lemma between $i <_b l_1 = true: bool$ and $i < l_1$ to get, amongst goals easily solved, 
      \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool)  \vdash  * :  (w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v): type \:\: (*)
     \]
     It suffices to show that
     \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool)  \vdash  \lambda \_.* : \Pi(m' : i <_b l_1 = true : bool)((w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v) : type) \: \: (**)
     \]
     \begin{itemize}
         \item I assume $(**)$ and show $(*)$\\
         By $(**)$ and 6, I have that 
         \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool)  \vdash  (\lambda \_.*) m : ((w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v) : type)
     \]
     $\beta$ reduction gives
       \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool)  \vdash  * : ((w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v) : type)
     \]
     But, this is exactly (*)
     \item Showing (**)\\
     I apply 121 with $M := i <_b l_1$ to generate\\
     $\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool)  \vdash i <_b l_1: bool$ (basic types) and 
   \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool), b: bool  \vdash \] 
   \[\lambda \_.* : \Pi(m' : b = true : bool)((w_1 \: i \: v \: l_v) = ((\lambda i. ite (b) (w_1 i) (x)) \: i \: v \: l_v) : type)
     \]
     I denote $\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: (i <_b l_1 = true : bool), b: bool$ as $\Gamma_1, b: bool$.
     Applying 5 yields $\Gamma_1, b: bool \vdash (b = true) : bool : type$ (which is straightforward) as well as
     \[\Gamma_1, b: bool, m' : b = true : bool \vdash * : \big((w_1 \: i \: v \: l_v) = ((\lambda i. ite (b) (w_1 i) (x)) \: i \: v \: l_v) : type \big) \] 
     %change here?
         Applying 120 gives 
         \begin{itemize}
             \item $\Gamma_1, b: bool, m' : b = true : bool \vdash 
             \big((w_1 \: i \: v \: l_v) = ((\lambda i. ite (b) (w_1 i) (x)) \: i \: v \: l_v) : type \big) : type
             $\\
             Similar reasoning to $cons_b: w_1 \:l_1\:x : pw$ to show that the $\lambda$ has type pw, then similar reasoning to section 0.2 
             %start here check number
             to show that both applications have type $U_0$.
             \item  $\Gamma_1, b: bool, m' : b = true : bool \vdash b = true : bool$\\
             basic types
             \item $FV(true) \cap \Gamma_2, b: bool = \emptyset$\\
             nice
             \item \[\Gamma_1, m' : true = true : bool \vdash 
             * : \big((w_1 \: i \: v \: l_v) = ((\lambda i. ite (true) (w_1 i) (x)) \: i \: v \: l_v) : type \big)
             \]
             After $\beta$ reduction, this is 
             \[\Gamma_1 \dots \vdash 
             * : \big(w_1 \: i \: v \: l_v =  w_1 i \: v \: l_v : type \big)
             \]
             which is to say 
             \[\Gamma_1 \dots \vdash  w_1 \: i \: v \: l_v: type
             \]
             This follows from the fact that $\Gamma_1 \vdash w_1: pw$ and 0.2 of preworld.
         \end{itemize}
     \end{itemize}
     
     
    % Equivalently
     %  \[\Gamma, v: \rhd pw, l_v: \rhd \N, i: \N, m: i < l_1  \vdash (w_1 \: i \: v \: l_v) = (w_2 \: i \: v \: l_v): type
     %\]




\section*{store}
Showing $\Gamma, w_1: pw, l_1: \N \vdash store(W_1) : U_0$\\
Apply 66 to get
\[\Gamma, w_1: pw, l_1 : \N, u: pw \vdash
\Pi(l : \N)\langle w_1, l_1 \rangle \leq \langle u, l \rangle \imp *w_1/\langle u, l \rangle
\]
Apply 4, 10, subseq to get
\[\Gamma, w_1: pw, l_1 : \N, u: pw, l : \N \vdash
*w_1/\langle u, l \rangle : U_0
\]
which is to say 
\[\Gamma, w_1: pw, l_1 : \N, u: pw, l : \N \vdash
\pi(i: \N). w_1 \: i (next \: u) \: (next\: l) : U_0
\]
Apply 4 to get
\[\Gamma, w_1: pw, l_1 : \N, u: pw, l : \N, i: \N \vdash
 w_1 \: i (next \: u) \: (next\: l) : U_0
\]
This follows from preworld and 35.


\section*{types}
For any $\tau$ in source language and $\Gamma$ where $\Gamma \vdash W_1 : world$, $\Gamma \vdash \tau@W_1 : U_0$. Induction on $\tau$.
\subsection{nat}
basic types
\subsection{$\tau_1 \imp \tau_2$}
    Apply 66 to get
    \begin{enumerate}
        \item $\Gamma \vdash pw : K_0$\\
        preworld
        \item $\Gamma, u: pw \vdash \Pi(l: \N) \dots :U_0$\\
        Apply 4
        \begin{enumerate}
            \item $\N : U_0$\\
            basic types
            \item $\Gamma, u: pw, l : \N \vdash 
            W_1 \leq U \imp \tau_1@U \imp \tau_2@U
            $\\
            Apply 10
            \begin{enumerate}
                \item $\Gamma, u: pw, l : \N \vdash 
            W_1 \leq U : U_0$\\
            subseq
            \item $\Gamma, u: pw, l : \N \vdash \tau_1@U \imp \tau_2@U : U_0$\\
            apply 10, by IH suffices to show that 
            $\Gamma, u: pw, l : \N \vdash U: world$. Apply (28 and 108), then 20. Suffices to show that 
            $\Gamma \dots \vdash \N: type$.
            \end{enumerate}
        \end{enumerate}
        \item $\Gamma \vdash 0: level$\\
        done
        \item $0 \leq 0$\\
       basic types
    \end{enumerate}
    \subsection{$\bigcirc \tau$}
    Apply 66 to get, amongst other goals solved before,
    \[\Gamma, u: pw \vdash \Pi(l : \N) W_1 \leq U \imp store(U) \imp \rhd \rhd \exists(v: pw)\Sigma(l' : \N)(U \leq \langle v, l' \rangle \times store\langle v, l' \rangle \times \tau @ \langle v, l' \rangle): U_0 \]
    Apply 4 to get $ \Gamma, u: pw \vdash \N : U_0$ and 
    \[\Gamma, u: pw, l : \N \vdash W_1 \leq U \imp store(U) \imp \rhd \rhd \exists(v: pw)\Sigma(l' : \N)(U \leq \langle v, l' \rangle \times store\langle v, l' \rangle \times \tau @ \langle v, l' \rangle): U_0\]
   Apply 10 repeatedly to get
   \begin{enumerate}
       \item $\Gamma, u: pw, l : \N \vdash W_1 \leq U : U
       _0$\\
       subseq
       \item $\Gamma, u: pw, l : \N \vdash store(U) : U_0$\\
       store
       \item $\Gamma, u: pw, l : \N \vdash \rhd \rhd \exists(v: pw)\Sigma(l' : \N)(U \leq \langle v, l' \rangle \times store\langle v, l' \rangle \times \tau @ \langle v, l' \rangle) : U_0$\\
       Apply the bar rule from bar types to get
       \[\Gamma, u: pw, l : \N \vdash  \exists(v: pw)\Sigma(l' : \N)(U \leq \langle v, l' \rangle \times store\langle v, l' \rangle \times \tau @ \langle v, l' \rangle) : U_0\]
       Apply 70 to get 
       \[\Gamma, u: pw, l : \N , v: pw \vdash \Sigma(l' : \N)(U \leq \langle v, l' \rangle \times store\langle v, l' \rangle \times \tau @ \langle v, l' \rangle) : U_0\]
       Apply 19 to get
        \[\Gamma, u: pw, l : \N , v: pw , l' : \N \vdash U \leq \langle v, l' \rangle \times store\langle v, l' \rangle \times \tau @ \langle v, l' \rangle : U_0\]
        Apply 27 twice to get
        \begin{itemize}
            \item  $\Gamma, u: pw, l : \N , v: pw , l' : \N \vdash U \leq \langle v, l' \rangle : U_0$\\
            subseq
            \item $\Gamma, u: pw, l : \N , v: pw , l' : \N \vdash store\langle v, l' \rangle : U_0$ \\
            store
            \item $\Gamma, u: pw, l : \N , v: pw , l' : \N \vdash \tau @ \langle v, l' \rangle : U_0$\\
            induction
        \end{itemize}
        
        \subsection{$ref \tau$}
        Apply 19 to get
        \[\Gamma, i: \N \vdash (i < l_1) \times
        \forall(u: \rhd pw)\Pi(l: \rhd \N)(w_1 i u l = \rhd (\tau @ U) : type)
        \]
        Apply 27 to get
        \begin{itemize}
            \item $\Gamma, i: \N \vdash (i < l_1) : U_0$\\
            basic types
            (to get $l_1 : \N$, $\beta$ reduce $\pi_2 \langle w_1, l_1 \rangle$ using $\Gamma \vdash \langle w_1, l_1 \rangle: world$)
            \item $\Gamma, i: \N \vdash \forall(u: \rhd pw)\Pi(l: \rhd \N)(w_1 i u l = \rhd (\tau @ U) : type) : U_0$\\
            Apply 66 to get
            \[\Gamma, i: \N, u: (\rhd pw) \vdash \Pi(l: \rhd \N)(w_1 i u l = \rhd (\tau @ U) : type) : U_0\]
            Apply 4 to get
              \[\Gamma, i: \N, u: \rhd pw, l : \rhd \N \vdash w_1 i u l = \rhd (\tau @ U) : type : U_0\]
              Apply 107
              \begin{itemize}
                  \item $\Gamma, i: \N, u: \rhd pw, l : \rhd \N \vdash w_1 i u l: U_0$\\
       preworld
                  \item $\Gamma, i: \N, u: \rhd pw, l : \rhd \N \vdash \rhd (\tau @ U) : type : U_0$\\
                  34, induction (with weakening)
              \end{itemize}
        \end{itemize}
    
     
   \end{enumerate}
   

\section*{move}
Given $\Gamma \vdash \langle w_1, l_1 \rangle, \langle w_2, l_2 \rangle : world$, $\Gamma \vdash m_0: \langle w_1, l_1 \rangle \leq \langle w_2, l_2 \rangle$. For source type $\tau$, showing \[\Gamma \vdash move_\tau m_0: \tau @ W_1 \imp \tau @ W_2\].

\subsection{move $\tau_1 \imp \tau_2$}
\Tree[.$\Gamma \vdash move_{\tau_1 \imp \tau_2}m_0:(\tau_1\imp\tau_2)@W_1\imp(\tau_1\imp\tau_2)@W_2\:\:(5)$ 
[.$\Gamma,f:\tau_1\imp\tau_2@W_1\vdash\lambda(l:\N)\dots :\tau_1\imp\tau_2@W_2$(67) [.$\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw\vdash\lambda(l:\N)\dots :\Pi(l:\N)\dots$(5x3) 
[.one ]
[.$\Gamma\dots u:pw,l:\N\vdash W_2\leq U:U_0$ [.\text{subseq} ] ]
[.$\Gamma\dots u:pw,l:\N\vdash\tau_1@U:U_0$ [.\text{types} ]]
]
[.$\Gamma\dots\vdash\:pw:K_0$ [.\text{preworld} ] ]
]
[.$\Gamma\vdash\tau_1\imp\tau_2@W_1:U_0$ [.\text{types} ]]
]

\subsection*{(one)}
Showing $\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw,l:\N,m:W_2\leq U,x:\tau_1@U\vdash fl(m\circ m_0)x:\tau_2@U$ \\
Repeated applications of (6,11, 108) yield the following goals
\begin{itemize}
    \item $\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw,l:\N,m:W_2\leq U,x:\tau_1@U\vdash x:\tau_1@U$\\
    Done
    \item  $\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw,l:\N,m:W_2\leq U \vdash (m \circ m_0):W_1\leq U$\\
    Done by subseq
    \item $\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw,l:\N,m:W_2\leq U,x:\tau_1@U\vdash l : \N$\\
    done
    \item $\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw,l:\N,m:W_2\leq U,x:\tau_1@U\vdash f: \Pi(l:\N).W_1 \leq U \imp \tau_1@U \imp \tau_2@U$\\
    I denote $\Gamma,f:\tau_1\imp\tau_2@W_1,u:pw,l:\N,m:W_2\leq U,x:\tau_1@U$ as $\Gamma'$.
    Apply 68 to get
    \begin{itemize}
    \item $\Gamma' \vdash f: \forall(x:pw)\Pi(l:\N).W_1 \leq  \langle x, l \rangle \imp \tau_1@ \langle x, l \rangle \imp \tau_2@ \langle x, l \rangle$\\
    done by def $\tau_1\imp\tau_2@W_1$
        \item $\Gamma' \vdash u : pw$\\
        done
        \item $\Gamma', x: pw \vdash \Pi(l:\N).W_1 \leq \langle x, l \rangle \imp \tau_1@ \langle x, l \rangle \imp \tau_2@ \langle x, l \rangle : type$\\
        By types I have $\Gamma' \vdash \tau_1 \imp \tau_2@W_1 : U_0$. Similar reasoning to the body of that proof gives that 
        $\Gamma', x: pw \vdash \Pi(l:\N).W_1 \leq \langle x, l \rangle \imp \tau_1@ \langle x, l \rangle \imp \tau_2@ \langle x, l \rangle : U_0$
    \end{itemize}
\end{itemize}

\subsection*{move $\bigcirc \tau$}
Apply 5, then 67, then 5 multiple times to get, amongst goals already solved by types, preworld, basic types, subseq, and store
\[\Gamma, c: \bigcirc(\tau) @ W_1, u: pw, l: \N, m: W_2 \leq U, s: store U \vdash \:\:\: (1)\] \[ c \: l \: (m \circ m
    _0) \: s: \rhd \rhd \exists(u_3: pw)\Sigma(l_3: \N)(\langle u_2, l_2 \rangle \leq \langle u_3, l_3 \rangle \times store\langle u_3, l_3 \rangle \times \tau @\langle u_3, l_3 \rangle)\]
    I denote context (1) as $\Gamma'$.
    Repeated applications of 6 and (108 with 11) give, amongst goals solved immediately by $\Gamma'$ or transitivity of subseq,
  \[\Gamma' \vdash c: \Pi(l: \N)(W_1 \leq U \imp store(U) \imp  \rhd \rhd \exists(u_3: pw)\Sigma(l_3: \N)(\langle u_2, l_2 \rangle \leq \langle u_3, l_3 \rangle \times store\langle u_3, l_3 \rangle \times \tau @\langle u_3, l_3 \rangle)\]
Apply 68 to this to get, amongst goals solved by preworld and types,
  \[\Gamma' \vdash c: \forall(u: pw)\Pi(l: \N)(W_1 \leq U \imp store(U) \imp  \rhd \rhd \exists(u_3: pw)\Sigma(l_3: \N)(\langle u_2, l_2 \rangle \leq \langle u_3, l_3 \rangle \times store\langle u_3, l_3 \rangle \times \tau @\langle u_3, l_3 \rangle)\]
  But, this is $c : \bigcirc(\tau) \in \Gamma'$.
  
  \subsection*{move $ref \tau$}
Apply 5 to get 
\[\Gamma, R: ref(\tau) @ W_1 \vdash \langle \pi_1 R, \langle (\pi_1\: m_0) \circ (\pi_1 \pi_2 R),
\lambda \_. * \rangle \rangle: ref(\tau) @ W_2
\]
Apply 20
\begin{itemize}
\item $\Gamma, R: ref(\tau) @ W_1, i : \N \vdash (i < l_2 \times
\forall(u: \rhd pw)\Pi(l: \rhd \N)(w \: i \: u \: l = \rhd (\tau @ U) : type): type $\\
Similar reasoning to the body of $\Gamma,  R: ref(\tau)@W_1 \vdash ref(\tau) @ W_2: U_0$
    \item $\Gamma, R: ref(\tau) @ W_1 \vdash \pi_1 R : \N$\\
    Apply 21
    \item $\Gamma, R: ref(\tau) @ W_1 \vdash $\\
    $\langle (\pi_1\: m_0) \circ (\pi_1 \pi_2 R),
\lambda \_. * \rangle: (\pi_1 R < l_2 \times
\forall(u: \rhd pw)\Pi(l: \rhd \N)(w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type
) $\\
Apply 108 with 28 to get\\
$\Gamma, R: ref(\tau) @ W_1 \vdash$\\
$\langle (\pi_1\: m_0) \circ (\pi_1 \pi_2 R),
\lambda \_. * \rangle: \Sigma(\pi_1 R < l_2).
\forall(u: \rhd pw)\Pi(l: \rhd \N)(w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type
) $.\\
Apply 20 to get 
\begin{itemize}
    \item $\Gamma, R: ref(\tau) @ W_1 \vdash \forall(u: \rhd pw)\Pi(l: \rhd \N)(w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type): type$\\
Use 121 with $\Gamma, R:  ref(\tau) @ W_1 \vdash \pi_1 R: \N$ to get
\[\Gamma, R: ref(\tau) @ W_1, i: \N \vdash \forall(u: \rhd pw)\Pi(l: \rhd \N)(w \: i \: u \: l = \rhd (\tau @ U) : type): type\].\\
Then, invert on $\Gamma, R: ref(\tau) @ W_1 \vdash ref(\tau) : U_0$ to get
\[\Gamma, R: ref(\tau) @ W_1 \vdash \_ \times \forall(u: \rhd pw)\Pi(l: \rhd \N)(w \: i \: u \: l = \rhd (\tau @ U) : type) : U_0\]

    \item $\Gamma, R: ref(\tau) @ W_1 \vdash (\pi_1\: m_0) \circ (\pi_1 \pi_2 R) : (\pi_1 R < l_2)$\\
    by transitivity of $<$, $\leq$, it suffices to show
    \begin{itemize}
        \item $\Gamma, R: ref(\tau) @ W_1 \vdash (\pi_1 \pi_2 R): \pi_1 R < l_1$\\
        Rule 21, rule (108 with 28), 
        \item $\Gamma, R: ref(\tau) @ W_1 \vdash \pi_1\: m_0: l_1 \leq l_2$\\
        rule (108 with 28), rule 21
    \end{itemize}
    \item $\Gamma, R: ref(\tau) @ W_1 \vdash \lambda \_. * : \Pi(l: \rhd \N)(w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type)$\\
    Apply 5\\
     $\Gamma, R: ref(\tau) @ W_1, l : \rhd \N \vdash  * :(w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type)$.\\
     By basic types 5) it suffices to show that 
     \[\Gamma, R: ref(\tau) @ W_1, l : \rhd \N \vdash  \pi_2 \pi_2 R :(w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type)\]. 
     Apply 22, rule (108 with 28) to get
     \[\Gamma, R: ref(\tau) @ W_1, l : \rhd \N \vdash \pi_2 R :((\pi_1 R) < l_1) \times (w \: (\pi_1 R) \: u \: l = \rhd (\tau @ U) : type)\]
     Apply 22.

\end{itemize}
\end{itemize}

\subsection*{$move_{\Gamma} m$}
For $\Gamma$ a context in the source language and $W_1, W_2$ where $\Delta \vdash W_1, W_2 : world$, if  $\Delta, \Gamma@W_1 \vdash m: W_1 \leq W_2$ and $\Delta, \Gamma@W_2 \vdash e : B$ and 
$\Gamma \cap FV(B) = \emptyset$,
then $\Delta, \Gamma @ W_1 \vdash move_{\Gamma} \:m \:e : B$.\\
Recall first that \[move_{\Gamma} \:m \:e \equiv
e[i := move_{\tau_i} \: m\: i]_{i: \tau_i \in \Gamma}
\]
I can rewrite this as 
\[move_{\Gamma} \:m \:e \equiv
e[i := move_{\tau_i} \: m\: i]_{i: \tau_i \in \Gamma}[j := j]_{j \in \Delta}
\]
To show
\[\Delta, \Gamma @ W_1 \vdash e[i := move_{\tau_i} \: m\: i]_{i: \tau_i \in \Gamma}[j := j]_{j \in \Delta} : B\]
I rewrite as
\[\Delta, \Gamma @ W_1 \vdash e[i := move_{\tau_i} \: m\: i]_{i: \tau_i \in \Gamma}[j := j]_{j \in \Delta} : B[i := move_{\tau_i} \: m\: i]_{i: \tau_i \in \Gamma}[j := j]_{j \in \Delta}\]
(allowed as $\Gamma \cap FV(B) = \emptyset$).
I apply rule 121 $|\Delta, \Gamma|$ times to get
\begin{itemize}
    \item $\Delta, \Gamma@W_1 \dots \vdash move_{\tau_i} m\:i : \tau_i @ W_2$ for $i: \tau_i \in \Gamma$
    (where $\dots$ denotes some extension to $\Delta, \Gamma@W_1$)\\
    Apply 6 to get $\Delta, \Gamma@W_1  \vdash i: \tau_i @ W_1$ (def $\Gamma@W_1$) and $\Delta, \Gamma@W_1  \vdash move_{\tau_i} m : \Pi(\_ : \tau_i@W_1).\tau_i @ W_2$. This follows from move, (108 with 11), and the fact that  $\Delta, \Gamma@W_1 \vdash m: W_1 \leq W_2$.
    \item $\Delta, \Gamma@W_1 \dots \vdash j : \tau_j$ for $j : \tau_j \in \Delta$\\
    Def $\Delta$
    \item $\Delta, \Gamma@W_2 \vdash e: B$\\
    given
\end{itemize}

\section*{translation}
When I write $\lambda (W_1: world)$, it is an abuse. I really mean $\lambda (l_1: \N)$ (the function really only takes the nat part of the world). I include the preworld part just to keep track. The same goes for $f \: W_1$. I really mean $f \: l_1$ but pass in the $W_1$ to keep track.\\
Showing that for any $\Gamma \vdash e : \tau$ in the source language and $\Delta \vdash  \langle w_1, l_1 \rangle : world$ in the target language,
$\Delta, \Gamma @ W_1 \vdash \bar{e}\: W_1 : \tau @ W_1$. I proceed by induction on $\Gamma \vdash e : \tau$.\\

\subsection{ap}
Have: $\Gamma \vdash e_1 \: e_2 : \tau_2$. \\
Showing: $\Delta, \Gamma@W_1 \vdash \big(\lambda W_1. \overline{e_1}W_1 \; l \; refl_{W_1} \; (\overline(e_2) W_1) \big) W_1 : \tau_2 @ W_1$. \\
$\beta$ reduce to get 
 $\Delta,\Gamma@W_1 \vdash  \overline{e_1}W_1 \; l_1 \; refl_{W_1} \; (\overline(e_2) W_1) : \tau_2 @ W_1$.
Apply 6 to get
\begin{itemize}
    \item $\Delta,\Gamma@W_1  \vdash \overline{e_1}W_1 \; l_1 \; refl_{W_1}: \Pi(e_2: \tau_1 @ W_1)(\tau_2 @ W_1)$\\
    108 with 11 gives \\
     \[\Delta,\Gamma \vdash \overline{e_1}W_1 \; l_1 \; refl_{W_1}: \tau_1 @ W_1 \imp \tau_2 @ W_1\]
     6 gives 
     \begin{itemize}
         \item  $\Delta, \Gamma@W_1  \vdash \overline{e_1}W_1 \; l_1: \Pi(W_1 \leq W_1).\tau_1 @ W_1 \imp \tau_2 @ W_1$
         108 with 11 gives\\
         $\Delta,\Gamma@W_1 \vdash \overline{e_1}W_1 \; l_1: W_1 \leq W_1 \imp \tau_1 @ W_1 \imp \tau_2 @ W_1$\\
         6 gives $\Delta,\Gamma@W_1  \vdash l_1 : \N$ (which follows from the fact that $\Delta,\Gamma@W_1  \vdash W_1 : world$ ) and
        \[\Delta,\Gamma@W_1 \vdash \overline{e_1}W_1: \Pi(l : \N) W_1 \leq \langle w_1, l \rangle \imp \tau_1 @ W_1 \imp \tau_2 @ W_1\]
         Apply 68 to get
         \begin{itemize}
             \item $\Delta,\Gamma@W_1 \vdash \overline{e_1}W_1: \forall(u: preworld)\Pi(l : \N) W_1 \leq U \imp \tau_1 @U  \imp \tau_2 @ U$\\
             induction on $\Gamma \vdash e_1 : \tau_1 \imp \tau_2$.
             \item $\Delta,\Gamma@W_1  \vdash w_1 : preworld$\\
             follows from the fact that $\Delta,\Gamma \vdash W_1 : world$
             \item $\Delta,\Gamma@W_1 , u : pw \vdash \Pi(l : \N) W_1 \leq U \imp \tau_1 @ U \imp \tau_2 @ U: type$\\
             Shown in proof that $(\tau_1 \imp \tau_2 @ W_1) : type$
         \end{itemize}
         \item $\Delta,\Gamma \vdash refl_{W_1} : W_1 \leq W_1$\\
         subseq, as $\Delta,\Gamma \vdash  W_1 : world$
     \end{itemize}

    \item $\Delta,\Gamma \vdash (\overline{e_2} W_1) : \tau_1 @ W_1$\\
IH on $\Gamma \vdash e_2 : \tau_1$
\end{itemize}

\subsection{lam}
Have: $\Gamma \vdash \lambda x. e : \tau_1 \imp \tau_2$. \\
Showing: $\Delta,\Gamma@W_1 \vdash \big(\lambda W_1. \lambda l. \lambda m . \lambda x. (move_{\Gamma}\:m\:(\overline{e} \: U)) \big) W_1 : (\tau_1 \imp \tau_2) @ W_1$. \\
$\beta$- reduce to get 
 $\Delta,\Gamma@W_1 \vdash  \lambda l. \lambda m . \lambda x. (move_{\Gamma}\:m\:(\overline{e} \: U)) : (\tau_1 \imp \tau_2) @ W_1$.\\
 Apply 67 to get 
 \[\Delta,\Gamma@W_1, u: pw \vdash  \lambda l. \lambda m . \lambda x. (move_{\Gamma}\:m\:(\overline{e} \: U)) : \Pi(l:\N).W_1 \leq U \imp \tau_1@U \imp \tau_2@U\]
 Apply 5 and (108 with 11) repeatedly to get
 \begin{itemize}
     \item $\Delta, \Gamma@W_1, u: pw, l: \N \vdash W_1 \leq U: type$\\
     subseq, as $\Delta,  u: pw, l : \N \dots \vdash W_1, U : world$
     \item $\Delta, \Gamma@W_1, u: pw, l : \N, m: W_1 \leq U \vdash \tau_1@U: type$\\
     types
     \item $\Delta, \Gamma@W_1, u: pw, l : \N, m: W_1 \leq U, x: \tau_1 @ U \vdash (move_{\Gamma}\:m\:(\overline{e} \: U)) : \tau_2@U$\\
     After applying result $move_{\Gamma}m$ with $\Delta := \Delta, u: pw, l: \N, m: W_1 \leq U$ and $\Gamma := \Gamma, x: \tau_1$
     I need show that
     \begin{itemize}
         \item $\Delta, u: pw, l: \N, m: W_1 \leq U \vdash W_1, U : world$
         Follows pretty fast from assumption that $\Delta \vdash W_1 : world$.
         \item $\Delta, u: pw, l: \N, m: W_1 \leq U, \Gamma @ W_1, x: \tau_1 @W_1 \vdash m : W_1 \leq U$\\
         Easy
         \item $\Delta, u: pw, l: \N, m: W_1 \leq U, \Gamma @ 
         U, x: \tau_1 @U \vdash \overline{e} \: U : \tau_2 @ U$\\
         I have $\Gamma, x: \tau_1 \vdash e : \tau_2$. My IH on this with $\Delta := \Delta, u: pw, l: \N, m: W_1 \leq U$ gives exactly
         \[\Delta, u: pw, l: \N, m: W_1 \leq U, \Gamma @ U, x: \tau_1 @U \vdash  \overline{e} \: U : \tau_2 @ U \]
         \item $\Gamma \cap FV(\tau_2 @ U) = \emptyset$\\
    By the above bullet and rule 129, I have 
    \[\Delta, u: pw, l: \N, m: W_1 \leq U, \Gamma @ U, x:\tau_1 @U \vdash  \tau_2 @ U: typ
    \]
         I have by structural rules that for any $i \in  \Gamma @ U$, $i \notin FV(\tau_2 @ U)$.
     \end{itemize}
     %Apply 6 to get
     %\begin{itemize}
      %   \item $\Gamma@W_1, u: pw, l : \N, m: W_1 \leq U, x: \tau_1 @ U \vdash move_{\tau_2} \:m: \Pi(\_:\tau_1@W_1). \tau_2@U$
       %  \item $\Gamma@W_1, u: pw, l : \N, m: W_1 \leq U, x: \tau_1 @ U \vdash (\overline{e}\: W_1) : \tau_2@W_1$\\
        % Induction on $\Gamma, x: \tau_1 @ U \vdash $
     %\end{itemize}
 \end{itemize}
 
 \subsection{ret}
Have: $\Gamma \vdash return(e) : \bigcirc \tau$. \\
Showing: \[\Delta,\Gamma@W_1 \vdash \big(\lambda W_1. \lambda l. \lambda m . \lambda s. return_{A\;target} \langle l, \langle refl_{u, l}, s, move_{\tau}\;m\;(\overline{e} \: W_1) \rangle\rangle \big) W_1
: (\bigcirc \tau) @ W_1\]
where 
\[A := \exists(v: pw)\Sigma(l_v : \N)U \leq \langle v, l_v\rangle \times store\langle v, l_v\rangle \times \tau@\langle v, l_v\rangle\]
$\beta$-reduce, apply 67
\[\Delta,\Gamma@W_1, u: pw \vdash \lambda l. \lambda m . \lambda s. return_{A\;target} \langle l, \langle refl_{u, l}, s, move_{\tau}\;m\;(\overline{e} \: W_1) \rangle\rangle
: \Pi(l: \N)W_1 \leq U \imp store(U) \imp \dots \]
Apply 5 and (108 with 11) repeatedly
\begin{itemize}
     \item $\Delta, \Gamma@W_1, u: pw, l: \N \vdash W_1 \leq U: type$\\
     subseq, as $\Delta,  u: pw, l : \N \dots \vdash W_1, U : world$
     \item $\Delta, \Gamma@W_1, u: pw, l : \N, m: W_1 \leq U \vdash  store(U) : type$\\
     store
     \item \[\Delta, \Gamma@W_1, u: pw, l : \N, m: W_1 \leq U, s: store(U) \vdash\]
     \[return_{A\;target}\langle l, \langle refl_{u, l}, s, move_{\tau}\;m\;(\overline{e} \: W_1) \rangle\rangle: \rhd \rhd \exists(v: pw)\Sigma(l_v : \N)U \leq \langle v, l_v\rangle \times store\langle v, l_v\rangle \times \tau@\langle v, l_v\rangle \]
     I denote $\Delta, \Gamma@W_1, u: pw, l : \N, m: W_1 \leq U, s: store(U) $ as $\Gamma'$.\\
     Apply 6 to get
     \begin{itemize}
         \item $\Gamma' \vdash return_{A\;target} : \Pi(\_ :A).\rhd \rhd A$\\
        apply return rule from bar types. suffices to show that
        $\Gamma' \vdash A: U_0$. as $A$ is a (structural) subterm of $\bigcirc \tau @ W_1$, this follows similar reasoning to the proof that $\Delta, \Gamma \vdash \tau @ W_1 : U_0$.
         \item $\Gamma' \vdash \langle l, \langle refl_{u, l}, s, move_{\tau}\;m\;(\overline{e} \: W_1) \rangle\rangle : A$\\
         Apply 71 to get $\Gamma' \vdash u : pw$ (easy by def $\Gamma'$) and 
         \begin{itemize}
             \item \[\Gamma' \vdash  \langle l, \langle refl_{u, l}, s, move_{\tau}\;m\;(\overline{e} \: W_1) \rangle\rangle: \Sigma(l_v : \N)U \leq \langle u, l_v\rangle \times store\langle u, l_v\rangle \times \tau@\langle u, l_v\rangle\]
             Apply 20 to get $\Gamma' \vdash l : \N$ (easy by def $\Gamma'$) and\\  $\Gamma', l_v: \N \vdash U \leq \langle u, l_v\rangle \times store\langle u, l_v\rangle \times \tau@\langle u, l_v\rangle : type$ (which follows the (subterm of $\bigcirc \tau @ W_1$) argument) and 
      \[\Gamma' \vdash \langle refl_{u, l}, s, move_{\tau}\;m\;(\overline{e} \: W_1) \rangle :
                 U \leq U \times store(U) \times \tau@U\]
                 Applying 20 multiple times gives
                 \begin{itemize}
                     \item $\Gamma' \vdash refl_{u, l} : U \leq U$\\
                     subseq
                     \item $\Gamma' \vdash s: store(U)$\\
                     def $\Gamma'$
                     \item $\Gamma' \vdash move_{\tau}\;m\;(\overline{e} \: W_1) : \tau @ U$\\
                     Applying 6 gives 
                     \begin{itemize}
                         \item $\Gamma' \vdash move_{\tau}\;m : \Pi(\_ : \tau @ W_1). \tau @ U$\\
                         result move gives that it suffices to show that $\Gamma' \vdash W_1, U : world$ and $\Gamma' \vdash m : W_1 \leq U$. The former follows by weakening and the latter by definition of $\Gamma'$.
                         \item $\Gamma' \vdash \overline{e} \: W_1 : \tau @ W_1$\\
                         Induction on the typing $\Gamma \vdash e : \tau$ gives $\Delta, \Gamma @ W_1 \vdash  \overline{e} \: W_1 : \tau @ W_1$. Weakening then gives $\Gamma' \vdash \overline{e} \: W_1 : \tau @ W_1$
                     \end{itemize}
                 \end{itemize}
          \item  \[\Gamma', v: pw \vdash \Sigma(l_v : \N)U \leq \langle v, l_v\rangle \times store\langle v, l_v\rangle \times \tau@\langle v, l_v\rangle\]
          As $\Sigma(l_v : \N)U \leq \langle v, l_v\rangle \times store\langle v, l_v\rangle \times \tau@\langle v, l_v\rangle$ is a subterm of $\bigcirc \tau @ W_1$, this follows similar reasoning to the proof that $\Gamma ' \vdash \tau @ W_1 : U_0$.
         \end{itemize}
     \end{itemize}
\end{itemize}

\subsection{bind}
%start here change namin convention to use $u_i$ instead of v
Have: $\Gamma \vdash bind(e_1,\; x.e_2) : \bigcirc \tau_2$. \\
Let
\[A :=\exists(v: pw)\Sigma(l_v : \N)(U \leq \langle v, l_v \rangle \times store\langle v, l_v \rangle \times \tau_1 @ \langle v, l_v \rangle)
\]
\[B :=\exists(v': pw)\Sigma(l_v' : \N)(U \leq \langle v', l_v' \rangle \times store\langle v', l_v' \rangle \times \tau_2 @ \langle v', l_v' \rangle)
\]
\[C :=\exists(v': pw)\Sigma(l_v' : \N)(\langle v, \pi_1 z \rangle \leq \langle v', l_v' \rangle \times store\langle v', l_v' \rangle \times \tau_2 @ \langle v', l_v' \rangle)
\]

\[\overline{e_2}' := \lambda x. \big(move_{\Gamma} \: (\pi_2 z \circ m) \: (\overline{e_2}\langle v,  \pi_1 z \rangle) \big) (\pi_4 \: z) \: \pi_1 z \: refl_{v, \: \pi_1 \: z} \: \pi_3 z\]
I am showing
\[\Delta,\Gamma@W_1 \vdash \lambda l. \lambda m . \lambda s. bind_{target}\;(\overline{e_1}\: W_1 \: l \: m \: s) \; \lambda (z_1 : A). \Big( bind_{target} \; \overline{e_2}'
\; 
\big( \dots \big) \Big) [z:= z_1]
: (\bigcirc \tau_2) @ W_1\]
Apply 67, then (5 and (108 with 11)) repeatedly to get
\begin{itemize}
    \item $\Delta,\Gamma@W_1, u: pw, l: \N \vdash W_1 \leq U: type$\\
    subseq, similar to ret proof
    \item $\Delta,\Gamma@W_1, u: pw, l: \N, m: W_1 \leq U \vdash store(U): type$\\
    store
    \item I denote $\Delta,\Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U)$ as $\Gamma'$. I need show
    \[\Gamma' \vdash bind_{target}\;(\overline{e_1}\: W_1 \: l \: m \: s) \; \lambda (z_1 : \exists v \dots ).\Big( bind_{target} \; \overline{e_2}'
\; 
\big( \dots \big) \Big) [z:= z_1] : \rhd \rhd B\]
Apply the bind rule to get
\begin{itemize}
    \item $\Gamma' \vdash \overline{e_1}\: W_1 \: l \: m \: s : \rhd \rhd A $\\
    Apply 6 and (108 with 11) multiple times to get
    \[\Gamma' \vdash \overline{e_1} \: W_1 : \Pi(l: \N). W_1 \leq U \imp store(U) \imp \rhd \rhd A\]
    Apply 68 to get (amongst goals solved before)
     \[\Gamma' \vdash \overline{e_1} \: W_1 : \forall(u: pw)\Pi(l: \N). W_1 \leq U \imp store(U) \imp \rhd \rhd A\]
    I have by induction on $\Gamma \vdash e_1 : \bigcirc \tau_1$ that $\Delta, \Gamma \vdash \overline{e_1} \: W_1 : (\bigcirc \tau_1) @ W_1$. The desired result follows by weakening. 
    \item \[\Gamma' \vdash \lambda \:z_1.\Big( bind_{target} \; \overline{e_2}'
\; \big(\lambda z_2. \big(return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle \big)[z' := z_2]\big) \Big) [z:= z_1] : A \imp \rhd \rhd B\]
Apply 5 to get (amongst goals solved before)
\[\Gamma', z_1: A  \vdash \Big( bind_{target} \; \overline{e_2}'
\; \big(\lambda z_2. \big(return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle \big)[z' := z_2]\big) \Big) [z:= z_1] : \rhd \rhd B\]
Apply 72 to get
\begin{itemize}
    \item $\Gamma', z_1: A \vdash z_1 : A$\\
done
    \item $\Gamma' \vdash pw: type$\\
    done
    \item $\Gamma', v: pw \vdash \Sigma(l_v : \N)U \leq \langle v, l_v\rangle \times store\langle v, l_v\rangle \times \tau_1@\langle v, l_v\rangle : type$\\
    Since the type above is a subterm of $\bigcirc \tau_1 @ U$ and since $\Gamma' \vdash \tau_1 @ U : U_0$ by types, I can use similar reasoning to that proof. Below, I denote
 $\Sigma(l_v : \N)U \leq \langle v, l_v\rangle \times store\langle v, l_v\rangle \times \tau_1@\langle v, l_v\rangle$ as $A'$.
 \end{itemize}
as well as \[\Gamma', v: pw, z:A'  \vdash  bind_{target} \; \overline{e_2}'
\; \big(\lambda z_2. \big(return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle \big)[z' := z_2]\big) : \rhd \rhd B\]
Applying the bind rule gives 
\begin{itemize}
    \item $\Gamma', v: pw, z:A'  \vdash \overline{e_2}' : \overline{C}$\\
    Recalling the definition of $\overline{e_2}'$, I am showing that 
    \[\Gamma', v: pw, z:A'  \vdash  \lambda x. \big(move_{\Gamma} \: (\pi_2 z \circ m) \: (\overline{e_2}\langle v,  \pi_1 z \rangle) \big) (\pi_4 z) \; \pi_1 z \; refl_{v, \: \pi_1 \: z} \; \pi_3 z : \overline{C}\]
    Applying 6 and (108 with 11) to this multiple times gives the following goals 
    \begin{itemize}
        \item $\Gamma', v: pw, z:A'  \vdash \pi_3 z : store(\langle v, \pi_1 z \rangle)$\\
        def $A'$, some wiggling involving the "third projection"
        \item $\Gamma', v: pw, z:A'  \vdash refl_{v, \: \pi_1 \: z} : \langle v, \pi_1 \: z \rangle \leq \langle v, \pi_1 \: z \rangle $
        by the reflexivity result in subseq it suffices to show that $\Gamma', v: pw, z:A' \vdash \pi_1 z : \N$. But, this follows from rule 21.
        \item $\Gamma', v: pw, z:A'  \vdash \pi_1 \: z : \N $\\
        see above bullet
    \end{itemize}
    as well as, with $V_{mid}$ abbreviating $\langle v, l_{mid} \rangle$ and $V$ abbreviating $\langle v, \pi_1 \: z \rangle$
    %and $V$ abbreviating $\langle v, \pi_1 z\rangle$
    \[\Gamma', v: pw, z:A'  \vdash \lambda x. \big(move_{\Gamma} \: (\pi_2 z \circ m) \: (\overline{e_2}\langle v,  \pi_1 z \rangle) \big) (\pi_4 \: z) :\] 
    \[\Pi(l_{mid} : \N) V \leq V_{mid} \imp store(V_{mid}) \imp \rhd \rhd 
    \exists(v': pw)\Sigma(l_v' : \N)(V_{mid} \leq \langle v', l_v' \rangle \times store\langle v', l_v' \rangle \times \tau_2 @ \langle v, l_v' \rangle)\]
    Apply rule 68 to get (amongst goals solved before)
        \[\Gamma', v: pw, z:A'  \vdash \lambda x. \big(move_{\Gamma} \: (\pi_2 z \circ m) \: (\overline{e_2}\langle v,  \pi_1 z \rangle) \big) (\pi_4 \: z) : \bigcirc \tau_2 @ V\] 
    Apply rule 6 to get  $\Gamma', v: pw, z:A'  \vdash \pi_4 \: z : \tau_1 @ V$ (easy by def $A'$) and
    \[\Gamma', v: pw, z:A' \vdash \lambda x. move_{\Gamma} \: (\pi_2 z \circ m) \: (\overline{e_2} \:V) :
    \Pi(\_ : \tau_1 @ V \imp ).\bigcirc \tau_2 @ V
    \] 
    Apply rule 5 to get $\Gamma' \dots \vdash  \tau_1 @ V : type$ (done in types) and 
    \[\Gamma', v: pw, z:A', x: \tau_1 @ V \vdash move_{\Gamma} \: (\pi_2 z \circ m) \: (\overline{e_2} \:V) : \bigcirc \tau_2 @ V\]
    By $move_{\Gamma}$ it suffices to show
    \begin{itemize}
        \item $\Delta, u: pw, l: \N, m: W_1 \leq U, v: pw, z:A' \vdash W_1, V: world$\\
        easy
        \item $\Delta, u: pw, l: \N, m: W_1 \leq U, v: pw, z:A' \vdash \pi_2 \: z \circ m : W_1 \leq V$\\
        transitivity of subseq
        \item $\Delta, u: pw, l: \N, m: W_1 \leq U, v: pw, z:A', \Gamma @ V, x: \tau_1 @V \vdash \overline{e_2} \:V\bigcirc \tau_2 @ V$\\
        I have that $\Gamma, x: \tau_1 \vdash e_2 : \bigcirc \tau_2$. IH on this gives exactly the result desired.
    \end{itemize}
    
    \item $\Gamma', v: pw, z: A' \vdash \lambda z_2. \big(return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle \big)[z' := z_2] : C \imp \overline{B}$\\
    Below, I denote $\Sigma(l_v' : \N)(\langle v, \pi_1 z\rangle \leq \langle v', l_v' \rangle \times store\langle v', l_v' \rangle \times \tau_2 @ \langle v', l_v' \rangle)$ as $C'$.\\
    Apply 5 to get 
    \[\Gamma', v: pw, z: A', z_2: C \vdash  \big(return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle \big)[z' := z_2] \overline{B}\]
    Apply 72 to get (amongst goals solved before)
    \[\Gamma', v: pw, z: A', v': pw, z': C' \vdash  return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle: \overline{B}\]
    Apply the return rule to get (as well as a goal solved before)
    \[\Gamma', v: pw, z: A', v': pw, z': C' \vdash 
    \langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle : B
    \]
    Apply 71 with v' := v' to get 
     \[\Gamma', v: pw, z: A', v': pw, z': C' \vdash 
    \langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z,\; \pi_3 z', \pi_4 z' \rangle \rangle :\]
    \[\Sigma(l_v' : \N)(U \leq \langle v', l_v' \rangle \times store\langle v', l_v' \rangle \times \tau_2 @ \langle v', l_v' \rangle)
    \]
    Multiple applications of rule 20 (with rule 108 and 28) gives
    \begin{itemize}
        \item $\Gamma', v: pw, z: A', v': pw, z': C' \vdash 
\pi_1 z' : \N$
\item $\pi_2 z' \circ \pi_2 z : U \leq \langle v', l_v' \rangle$\\
Follows from def $C'$, $A'$ (some wiggling with projections)
%start here
that $\pi_2 z' : \langle v, \pi_1 z \rangle \leq \langle v', l_v' \rangle$ and $\pi_2 z :U \leq \langle v, \pi_1 z \rangle$
\item $\pi_3 z' : store\langle v', l_v' \rangle $\\
def $C'$
%start here
\item $\pi_4 z' : \tau_2 @ \langle v', l_v' \rangle$
def $C'$
%start here
    \end{itemize}
\end{itemize}

%% dots \[\big(\lambda z_2. \big(return_{target}\langle \pi_1 z', \langle \pi_2 z' \circ \pi_2 z, \pi_3 z', \pi_4 z' \rangle \rangle \big)[z' := z_2]\big) \Big) [z:= z_1] : A \imp \rhd \rhd B\]
\end{itemize}

\end{itemize}

%\rhd \rhd\]

%\Pi(l: \N)W_1 \leq U \imp store(U) \imp 
%
%\]

\subsection{ref}
Have: $\Gamma \vdash ref(e) : \bigcirc(ref \tau )$. \\
Let $m_1$ denote $ \langle *, \lambda l_v. \lambda i. \lambda m_i. * \rangle$.\\
Let $p_1$ denote
\[\langle \langle *, \lambda l_v. \lambda i. \lambda m_i. * \rangle , \lambda l_2. \lambda m_2. \lambda i. ite \; (i <_b l) \;
((s \: l_2) (m_2 \circ m_1)\: i) \; (next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e} W_1)))
\rangle\]
Let $u_1$ be as written in the jamboard.\\
Let $x$ denote \[\text{let next }v' = v \text{ in let next } l_v' = l_v \text{ in } \rhd(\tau @ \langle v', l_v' \rangle)\]
\\
Showing: \[\Delta, \Gamma@W_1 \vdash \lambda (l : \N). \lambda (m: W_1 \leq U). \lambda (s: store(U)).return_{target} \langle succ(l), \langle p_1, \langle l, *, \lambda \_. *
\rangle \rangle \rangle : \bigcirc (ref \tau ) @ W_1\]
Apply 67, then (5 and (108 with 11)) repeatedly to get (amongst goals solved before)
\[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash return_{target} \langle succ(l), \langle p_1, \langle l, *, \lambda \_. *
\rangle \rangle \rangle :\] 
\[\rhd \rhd \exists(v: pw)\Sigma(l_v: \N) U \leq \langle v, l_v \rangle \times store\langle v, l_v \rangle \times (ref \tau)@\langle v, l_v \rangle
\]
Apply the return rule 
\[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash  \langle succ(l), \langle p_1, \langle l, *, \lambda \_. *
\rangle \rangle \rangle :\] \[\exists(v: pw)\Sigma(l_v: \N) U \leq \langle v, l_v \rangle \times store\langle v, l_v \rangle \times (ref \tau)@\langle v, l_v \rangle\] 
Apply 71 to get
\begin{itemize}
    \item \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash  u_1: pw\]
    By $cons_b$ suffices to show $\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash u : pw, l : \N$ (easy) and
    \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash \lambda v. \lambda l_v. x:\]  
    \[\rhd pw \imp_k \rhd \N \imp U_0 
    \]
    Apply (108 with 16), then (108 with 11), then 5, then (108 with 11), then 5 again to get
     \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U), v: \rhd pw, l_v: \rhd \N \vdash x: U_0\]
     By 122
      \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U), v: \rhd pw, l_v: \rhd \N \vdash x: \text{let next v' = v in $U_0$}\]
      Then by 36 
 \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U), v: \rhd pw, l_v: \rhd \N, v': \underline{pw} \vdash \text{let next } l_v' = l_v \text{ in } \rhd(\tau @ \langle v', l_v' \rangle): U_0\]
 Similar reasoning gives 
 \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U), v: \rhd pw, l_v: \rhd \N, v': \underline{pw}, l_v' : \underline{\N} \vdash  \rhd(\tau @ \langle v', l_v' \rangle): U_0\]
   Apply 34
    \[\overline{\Delta}, \overline{\Gamma@W_1}, u: pw, l: \N, m: W_1 \leq U, s: store(U), v: \rhd pw, l_v: \rhd \N, v': pw, l_v' : \N \vdash \tau @ \langle v',  l_v' \rangle: U_0\]
    Follows from types 
    \item \[\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash  \langle succ(l), \langle p_1, \langle l, *, \lambda \_. *
\rangle \rangle \rangle :\] \[\Sigma(l_v: \N) U \leq \langle u_1, l_v \rangle \times store\langle u_1, l_v \rangle \times (ref \tau)@\langle u_1, l_v \rangle\]
 Let $\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U)$ be denoted $\Gamma'$.\\
 I abbreviate $\langle u_1, succ(l) \rangle$ as $U_1$ and $\langle u_2, l_2 \rangle$ as $U_2$\\
Multiple applications of 20 yield $\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash succ(l) : \N$, as well as
\begin{itemize}
    \item $\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash p_1 : U \leq \langle u_1, succ(l) \rangle \times store\langle u_1, succ(l) \rangle$\\
    
    Recall the definition of $p_1$, apply 20. 
    \subsection*{1st projection}
    Showing \[\Gamma' \vdash m_1 : U \leq U_1\]
    Recalling that $u_1 := \langle cons_b \: u\:  l\: \lambda v. \lambda l_v. x , succ(l) \rangle$, it follows from result $cons_b$ in subseq that I need only show $\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash U : world$ (easy) and $\Delta, \Gamma@W_1, u: pw, l: \N, m: W_1 \leq U, s: store(U) \vdash \lambda v. \lambda l_v. x : \rhd pw \imp_k \rhd N \imp U_0$ (done in round bullet above).
    \subsection*{2nd projection}
    Showing 
    \[\Gamma' \vdash \lambda l_2. \lambda m_2. \lambda i. ite \; (i <_b l) \;
((s \: l_2) (m_2 \circ m_1)\: i) \; (next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e} W_1))) :store(U_1)\]
Apply 67 to get
\[\Gamma', u_2: pw \vdash \lambda l_2. \lambda m_2. \lambda i. ite \; (i <_b l) \;
((s \: l_2) (m_2 \circ m_1)\: i) \; (next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e} W_1))) :\]
\[\Pi(l_2 : \N)U_1 \leq U_2 \imp *u_1/ U_2
\]
Applying 5 x3 (along with 108 and 11)
gives 
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N  \vdash\] \[ ite \; (i <_b l) \;
((s \: l_2) (m_2 \circ m_1)\: i) \; (next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1))) : u_1 \: i \: (next \: u_2)
(next \: l_2)
\]
Apply 121 with $M : = i<_b l$ to get  
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash\] \[ ite \; b \;
((s \: l_2) (m_2 \circ m_1)\: i) \; (next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1))) :\]
\[\Big( \lambda i. ite \; b\; (u\:i)(\lambda v. \lambda l_v. x) i \Big)\: i \: (next \: u_2)
(next \: l_2)
\]
$\beta$ reduce to get
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash\] \[ ite \; b \;
((s \: l_2) (m_2 \circ m_1)\: i) \; (next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1))) :\]
\[ \Big( ite \; b\; (u\:i)(\lambda v. \lambda l_v. x) i \Big) \: (next \: u_2)
(next \: l_2)
\]
Apply 57 to get
\begin{itemize}
    \item
      \[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash\] \[(s \: l_2) (m_2 \circ m_1) \: i :\Big( ite \; true\; (u\:i)(\lambda v. \lambda l_v. x) i \Big) \: (next \: u_2)
(next \: l_2)
\]
    which $\beta$ reduces to 
    \[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash (s \: l_2) (m_2 \circ m_1)\:i  :u \: i \: (next \: u_2)
(next \: l_2)
\]
Apply 6 twice to get (amgonst goals easily solved)
\begin{itemize}
    \item  \[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash (m_2 \circ m_1): U \leq U_2
\]
In '1st projection', I showed that $\Gamma' \vdash m_1 : U \leq U_1$. This and transitivity of subseq gives the above.
\item \[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash (s \: l_2) : \Pi(U \leq U_2). \Pi(i: \N)\big(u \: i \: (next \: u_2)
(next \: l_2) \big)
\]
Apply 108 with 11, then apply 6 to get $\Gamma' \dots \vdash l_2: \N$ (easy) as well as 
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash s : \Pi(l_2: \N).U \leq U_2 \imp \Pi(i: \N)\big(u \: i \: (next \: u_2)
(next \: l_2) \big)
\]
Apply 68 to get
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash s : \forall(u_2: pw)\Pi(l_2: \N).U \leq U_2 \imp \Pi(i: \N)\big(u \: i \: (next \: u_2)
(next \: l_2) \big)
\]
In other terms 
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N \vdash s : store(U)
\]
This follows immediately from the def of $\Gamma'$.
\end{itemize}
\item 
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash  next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1)) :\]
\[ \Big( ite \; false \; (u\:i)(\lambda v. \lambda l_v. x) i \Big) \: (next \: u_2)
(next \: l_2)
\]
which $\beta$ reduces to 
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash  next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1)) :\]
\[\text{let next }v' = (next \: u_2) \text{ in let next } l_v' = (next \: l_2) \text{ in } \rhd(\tau @ \langle v', l_v' \rangle)\]
This reduces further to
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash  next
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1)) : \rhd(\tau @ \langle u_2, l_2 \rangle)\]
Apply 35 (and the weaking rule for promotion)
\[\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash 
(move_{\tau}(m_2 \circ m_1 \circ m) 
(\overline{e}\: W_1)) : \tau @ \langle u_2, l_2 \rangle\]
By $move$, 6, and (108 with 11) it suffices to show that
\begin{itemize}
    \item $\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash m_2 \circ m_1 \circ m: W_1 \leq U_2$\\
    By def $\Gamma'$ I have that $m : W_1 \leq U$. I showed in 1st projection that $\Gamma' \vdash m_1 : U \leq U_1$. The result then follows from transitivity of $\leq$.
    \item $\Gamma', u_2: pw, l_2: \N, m_2:U_1 \leq U_2, i : \N, b: bool  \vdash \overline{e}\: W_1 : \tau @ W_1$\\
    I have that $\Gamma \vdash e: \tau$. My IH then gives that $\Delta, \Gamma \vdash \overline{e}\: W_1 : \tau @ W_1$. The desired result comes from weakening.
\end{itemize}
\end{itemize}
    \item $\Gamma' \vdash \langle l, *, \lambda \_. *
\rangle \rangle:  (ref \tau)@\langle u_1, succ(l) \rangle$\\
Apply 20 twice (along with 108 and 28) to generate
\begin{itemize}
    \item $\Gamma' \vdash l : \N$\\
by def $\Gamma'$
    \item $\Gamma' \vdash * : l < succ(l)$\\
    basic types
    \item $\Gamma' \vdash  \lambda \_. *
: \forall(v: pw)\Pi(l_v: \N)((u_1 \: l \:  (next \:v) \: (next \: l_v)) = \rhd (\tau @ \langle v, l_v \rangle) : type
)$\\
Apply 67 and 5 to get
\[\Gamma', v: pw, l_v: \N \vdash   *
: (u_1 \: l \:  (next \:v) \: (next \: l_v)) = \rhd (\tau @ \langle v, l_v \rangle) : type
\]
Recalling the definition of $u_1$, this is equivalent to 
\[\Gamma', v: pw, l_v: \N \vdash   *
: \big((\lambda i. ite \: (i <_b l) \: (u \: i) \: \lambda v. \lambda l_v. x) \: l \:  (next \:v) \: (next \: l_v)\big) = \rhd (\tau @ \langle v, l_v \rangle) : type
\]
$\beta$ reduction gives 
\[\Gamma', v: pw, l_v: \N \vdash   *
: \big( ite \: (l <_b l) \: (u \: l) \: \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type \:\: (*)
\]
It suffices to show that
     \[(**)\:\: \Gamma', v: \rhd pw, l_v: \rhd \N \vdash  \lambda \_.* :\]
     \[\Pi(m' : l <_b l = false : bool)\Big(\big( ite \: (l <_b l) \: (u \: l) \: \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type \Big) 
     \]
     \begin{itemize}
     \item
     \item I assume $(**)$ and show $(*)$\\
     By basic types I have that $\Gamma' \dots \vdash * :  (l <_b l = false : bool)$. So, by $(**)$ and 6, I have that 
     \[\Gamma' \dots \vdash \lambda \_.* \: * : 
    \big( ite \: (l <_b l) \: (u \: l) \: \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type
     \]
     $\beta$ reduction gives exactly (*).
     \item I show $(**)$\\
  I apply 121 with $M := l <_b l$ to generate\\
  \[\Gamma' \dots b: bool \vdash 
  \lambda \_.* :\Pi(m' : b = false : bool)\Big(\big( ite \: b \: (u \: l) \: \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type \Big)
  \]
  Apply 5 for 
   \[\Gamma' \dots b: bool, m' : b = false : bool \vdash
* :\big( ite \: b \: (u \: l) \: \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type
  \]
  Apply 120 with $M:= false$ to get, amongst goals solved before 
  %(It was shown above (1st big round bullet) that
%$\Gamma' \vdash \lambda v. \lambda l_v. x: \rhd pw \imp_k \imp \rhd \N \imp U_0$
     \[\Gamma' \dots m' : false = false : bool \vdash\]
\[* :\big( ite \: false \: (u \: l) \: \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type
  \]
  After $\beta$ reduction, this is 
  \[\Gamma'  \vdash
* : \big( \lambda v. \lambda l_v. x \big) \:  (next \:v) \: (next \: l_v) = \rhd (\tau @ \langle v, l_v \rangle) : type
  \]
     \end{itemize}

Definition of $x$ and more $\beta$ reduction gives
\[\Gamma', v: pw, l_v: \N \vdash   *
:  \text{let next }v' = (next \: v) \text{ in let next } l_v' = (next \: l_v) \text{ in } \rhd(\tau @ \langle v', l_v' \rangle)
= \rhd (\tau @ \langle v, l_v \rangle) : type
\]
$\beta$ reduction again gives 
\[\Gamma', v: pw, l_v: \N \vdash   *
:  \rhd(\tau @ \langle v, l_v \rangle)
= \rhd (\tau @ \langle v, l_v \rangle) : type
\]
Apply 33 and use the promotion-weakening lemma to get 
\[\Gamma', v: pw, l_v: \N \vdash   *
:  \tau @ \langle v, l_v \rangle
= \tau @ \langle v, l_v \rangle : type
\]
This follows from types and the fact that $\Gamma', v: pw, l_v: \N \vdash \langle v, l_v \rangle : world$.
\end{itemize}


\end{itemize}
\end{itemize}





 

\section*{bar types}

\subsection*{bind rule }
$\Gamma \vdash M_0 : \overline{A}$ and $\Gamma \vdash M_1 : A \imp \overline{B}$ means that $\Gamma \vdash bind_{target\; A \; B} M_0 \: M_1 : \overline{B}$. 

\subsection{return rule}
If $\Gamma \vdash A : U_0$ then $\Gamma \vdash return_{A \; target} : \Pi(\_ : A). \rhd \rhd A$.

\subsection{bar rule}
If $\Gamma \vdash A : U_i$ then
$\Gamma \vdash \rhd \rhd A : U_i$

\section*{basic types}
\begin{enumerate}
    \item $\N : U_0$
    \item $l_i : \N$ gives $l_1 \leq l_2 : U_0$
    \item Transitivity of $\leq$\\
    $\Gamma \vdash q_1: l_1 \leq l_2$ and 
    $\Gamma \vdash q_2: l_2 \leq l_3$ gives
     $\Gamma \vdash q: l_1 \leq l_3$
     \item $\Gamma \vdash A = B$ gives that $\Gamma \vdash A \leq B$
     \item If $\Gamma \vdash x: (A = B): type$, then $\Gamma \vdash A = B : type$\\
     I'm showing $\Gamma \vdash * = * : (A = B : type)$. I have
     \begin{align}
         \Gamma \vdash (x = *):& (A = B) : type &\text{111}\\
          \Gamma \vdash (* = x):& (A = B) : type &\text{124}\\
           \Gamma \vdash (* = *):& (A = B) : type &\text{125}
     \end{align}
      \item refl of $\leq$
      \item trans of $<$ to $\leq$ (in that order)
      %as of right now only need 0 <= 0
      $\Gamma \vdash  i < j$, $\Gamma \vdash j \leq k$ gives $\Gamma \vdash i < k$
      \item Boolean lt for nats
      \item reflection of $=_{nat}$ with $==_{nat}$\\
      $\Gamma \vdash i, j : \N$ means $\Gamma \vdash (i = j : \N) = ((i == j) = true : bool) : type$
      \item reflection of $<$ with $<_b$\\
       $\Gamma \vdash i, j : \N$ means $\Gamma \vdash (i < j) = ((i == j) = true : bool) : type$
      \item $\Gamma \vdash l : \N$ gives $\Gamma \vdash * : l \leq succ(l)$
      \item $A = B : type$ means $A \subseteq B$ and $B \subseteq A$
      \item $l < succ(l)$
      \item $l < l = false: bool$
      \item $\Gamma \vdash m: (M = true : bool)$
    and $\Gamma \vdash P : type$ means that
        $\Gamma \vdash ite (M) \: P\: Q = P : type$.
\end{enumerate}

\section*{structural rules}
\begin{enumerate}
    \item if $\Gamma \vdash \tau_1 @ W_1 :typ$ and $x: \tau_x @ W_x \in \Gamma$, then $x \notin FV(\tau_1 @ W_1)$\\
    induction on $\tau_1$. need some concept of what it means to be a free variable. 
\end{enumerate}



\end{document}

%%% Local Variables:
%%% mode: plain-tex
%%% TeX-master: t
%%% End:

\message{ !name(paper.tex) !offset(-1027) }
